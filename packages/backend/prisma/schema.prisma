generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  apiKey    String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  applications Application[]

  @@index([slug])
  @@index([apiKey])
}

model User {
  id           String   @id @default(uuid())
  tenantId     String
  email        String
  passwordHash String
  role         String   @default("agent")
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  applications Application[]

  @@unique([tenantId, email])
  @@index([tenantId])
}

model Application {
  id                    String    @id @default(uuid())
  tenantId              String
  userId                String?
  status                String    @default("draft")
  currentStep           Int       @default(1)
  completionPct         Int       @default(0)
  ipAddress             String?
  userAgent             String?
  contactFirstName      String?
  contactLastName       String?
  contactEmail          String?
  contactPhone          String?
  tcpaConsentStep1      Boolean   @default(false)
  tcpaConsentStep1At    DateTime?
  hasAdditionalOwners   Boolean?
  lastActivityAt        DateTime  @default(now())
  warmLeadSentAt        DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  tenant          Tenant             @relation(fields: [tenantId], references: [id])
  user            User?              @relation(fields: [userId], references: [id])
  business        BusinessInfo?
  owners          OwnerInfo[]
  financial       FinancialInfo?
  loanRequest     LoanRequest?
  signature       Signature?
  analyticsEvents AnalyticsEvent[]
  auditLogs       AuditLog[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([status, tcpaConsentStep1, warmLeadSentAt, lastActivityAt])
}

model BusinessInfo {
  id                String   @id @default(uuid())
  applicationId     String   @unique
  legalName         String?
  dba               String?
  entityType        String?
  industry          String?
  stateOfFormation  String?
  ein               String?
  businessStartDate DateTime?
  phone             String?
  website           String?
  streetAddress     String?
  streetAddress2    String?
  city              String?
  state             String?
  zipCode           String?
  sicCode           String?
  naicsCode         String?
  autoPopulated     Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
}

model OwnerInfo {
  id              String   @id @default(uuid())
  applicationId   String
  ownerIndex      Int      @default(0)
  firstName       String?
  lastName        String?
  email           String?
  phone           String?
  ownershipPct    String?  // stored as string (e.g., "51")
  ssnEncrypted    String?
  dateOfBirth     String?  // stored as string (YYYY-MM-DD)
  creditScore     String?
  streetAddress   String?
  streetAddress2  String?
  city            String?
  state           String?
  zipCode         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@unique([applicationId, ownerIndex])
  @@index([applicationId])
}

model FinancialInfo {
  id                   String   @id @default(uuid())
  applicationId        String   @unique
  annualRevenue        String?  // dropdown range value (e.g., "100k-250k")
  monthlyRevenue       Float?   // deprecated - kept for backwards compatibility
  monthlyExpenses      Float?   // deprecated - kept for backwards compatibility
  outstandingDebts     Float?   // deprecated - kept for backwards compatibility
  bankruptcyHistory    Boolean? // deprecated - kept for backwards compatibility
  bankName             String?  // deprecated - kept for backwards compatibility
  accountType          String?  // deprecated - kept for backwards compatibility
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
}

model LoanRequest {
  id              String   @id @default(uuid())
  applicationId   String   @unique
  amountRequested String?  // dropdown range value (e.g., "50k-100k")
  purpose         String?
  urgency         String?
  termPreference  String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
}

model Signature {
  id                        String    @id @default(uuid())
  applicationId             String    @unique
  signatureData             String
  signerName                String
  signerEmail               String
  ipAddress                 String
  userAgent                 String
  consentText               String
  signedAt                  DateTime
  marketingConsent          Boolean   @default(false)
  marketingConsentTimestamp DateTime?
  createdAt                 DateTime  @default(now())

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
}

model AnalyticsEvent {
  id            String   @id @default(uuid())
  applicationId String
  fieldName     String?
  eventType     String
  durationMs    Int?
  metadata      Json?
  createdAt     DateTime @default(now())

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([eventType])
}

model AuditLog {
  id            String   @id @default(uuid())
  applicationId String
  action        String
  actor         String?
  ipAddress     String?
  details       Json?
  createdAt     DateTime @default(now())

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
}

